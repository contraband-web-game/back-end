<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONTRABAND: 작전 복귀</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Creepster&family=Gloria+Hallelujah&family=East+Sea+Dokdo&family=Nanum+Pen+Script&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    display: ['Creepster', 'East Sea Dokdo', 'cursive'],
                    hand: ['Amatic SC', 'East Sea Dokdo', 'cursive'],
                    body: ['Gloria Hallelujah', 'Nanum Pen Script', 'cursive'],
                },
                colors: {
                    paper: { DEFAULT: '#d5bdaf' },
                    ink: { DEFAULT: '#2f1b1b', red: '#7f1d1d' }
                },
                boxShadow: { 'sketch': '2px 2px 0px 0px rgba(0,0,0,0.8)' },
            }
        }
    }
  </script>
  <style>
    body {
        background-color: #1a1515;
        color: #2f1b1b;
        background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
    }
    .sketch-box {
        background-color: #d5bdaf;
        border: 2px solid #000;
        position: relative;
        border-radius: 2px 255px 3px 25px / 255px 5px 225px 5px;
        box-shadow: 5px 5px 0 rgba(0,0,0,0.5);
        transition: all 0.2s ease-in-out;
        background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
    }
    .sketch-box:hover {
        transform: scale(1.01) rotate(-0.5deg);
        box-shadow: 7px 7px 0 rgba(127, 29, 29, 0.6);
    }
    .sketch-btn {
        font-family: 'Amatic SC', 'East Sea Dokdo', cursive;
        font-weight: 700;
        font-size: 1.35rem;
        background: #2f1b1b;
        color: #d5bdaf;
        border: none;
        clip-path: polygon(0% 5%, 5% 0%, 95% 0%, 100% 5%, 100% 95%, 95% 100%, 5% 100%, 0% 95%, 2% 50%, 0% 5%);
        transition: transform 0.1s;
    }
    .sketch-btn:hover {
        transform: scale(1.05) rotate(1deg);
        background: #7f1d1d;
        color: #fff;
    }
    .sketch-btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        background: #4a4a4a;
    }
    .vignette {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        box-shadow: 0 0 200px rgba(0,0,0,0.9) inset;
        pointer-events: none;
        z-index: 50;
    }
    * {
        scrollbar-width: thin;
        scrollbar-color: #d5bdaf #2f1b1b;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #2f1b1b; }
    ::-webkit-scrollbar-thumb { background: #d5bdaf; border: 1px solid #000; }
  </style>
</head>
<body class="antialiased min-h-screen overflow-x-hidden">

<div class="vignette"></div>
<div class="fixed inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1518182170546-0766ce6fec56?q=80&w=2574&auto=format&fit=crop')] bg-cover bg-center pointer-events-none grayscale contrast-150"></div>

<main class="relative z-10 max-w-5xl mx-auto px-4 py-10 space-y-6">
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-5xl font-display text-ink-red tracking-wide">밀수: 작전 복귀</h1>
      <p id="user-label" class="text-lg font-body text-ink/70 mt-1"></p>
    </div>
    <div class="sketch-box p-4 rotate-1 flex items-center gap-3 shadow-sketch">
      <div class="p-2 bg-ink text-paper rounded-full shadow-lg">
        <i data-lucide="radar" class="w-6 h-6"></i>
      </div>
      <div>
        <p class="font-hand text-xl text-ink/80 leading-tight">진행 중인 작전으로</p>
        <p class="font-hand text-2xl text-ink font-bold leading-tight">바로 복귀하라</p>
      </div>
    </div>
  </header>

  <section class="sketch-box p-6 space-y-4 rotate-[-1deg]">
    <div class="flex items-center gap-3">
      <div class="p-3 bg-ink text-paper rounded-full shadow-lg">
        <i data-lucide="history" class="w-6 h-6"></i>
      </div>
      <div>
        <p class="font-hand text-xl text-ink/70">현재 상태</p>
        <p id="resume-status" class="text-3xl font-display text-ink">기록을 불러오는 중...</p>
      </div>
    </div>
    <div id="context-detail" class="grid grid-cols-1 gap-3 font-body text-lg text-ink/80">
      <div class="p-3 bg-white/60 border border-ink/30 rounded shadow-inner">
        <p class="font-hand text-xl text-ink font-bold">참여 중인 게임</p>
        <p id="room-entity" class="text-ink">-</p>
      </div>
    </div>
  </section>

  <section class="grid grid-cols-1 gap-4">
    <button id="btn-resume-game" class="sketch-btn px-6 py-4 shadow-xl w-full flex items-center justify-center gap-2">
      <i data-lucide="play" class="w-6 h-6"></i>
      <span>진행 중 작전으로 복귀</span>
    </button>
  </section>
</main>

<script src="js/cb-common.js"></script>
<script src="js/rules-modal.js"></script>
<script>
  lucide.createIcons();

  (async function resumePage() {
      const statusEl = document.getElementById('resume-status');
      const roomEl = document.getElementById('room-entity');
      const btnResumeGame = document.getElementById('btn-resume-game');
      const userLabel = document.getElementById('user-label');

      const session = window.cbCommon?.requireSession ? window.cbCommon.requireSession() : null;
      if (!session) {
          window.location.href = '/index-new.html';
          return;
      }

      userLabel.textContent = `요원: ${session.nickname || '익명'} (ID: ${session.userId})`;

      const state = {
          roomContext: window.cbCommon.loadRoomContext(),
          lobbyPayload: window.cbCommon.loadLobbyPayload(),
          gamePayload: window.cbCommon.loadGamePayload(),
          serverGame: null,
          redirectTimer: null
      };

      function setStatus(text, accent) {
          statusEl.textContent = text;
          statusEl.className = `text-3xl font-display ${accent === 'warn' ? 'text-ink-red' : 'text-ink'}`;
      }

      function fillContext() {
          const roomId = state.serverGame?.roomId || state.roomContext?.roomId || '-';
          const entityId = state.serverGame?.entityId || state.roomContext?.entityId || '-';
          const lobbyName = state.lobbyPayload?.lobbyName || state.gamePayload?.lobbyName || `방 ${roomId}`;
          roomEl.textContent = lobbyName ? lobbyName : `${roomId} / ${entityId}`;
      }

      function queueRedirect(target, delayMs) {
          if (state.redirectTimer) clearTimeout(state.redirectTimer);
          state.redirectTimer = setTimeout(() => {
              window.location.href = target;
          }, delayMs);
      }

      async function init() {
          fillContext();
          const hasGame = !!(state.roomContext?.roomId || state.gamePayload);
          if (!hasGame) {
              setStatus('진행 중 게임이 없습니다.', 'warn');
              queueRedirect('/lobby-list.html', 600);
              return;
          }

          // 버튼 정책: 진행 중 게임만 복귀 가능하도록 나머지는 비활성화
          // 불필요한 버튼 제거 후 안전 가드
          const btnResumeLobby = document.getElementById('btn-resume-lobby');
          const btnToList = document.getElementById('btn-to-list');
          if (btnResumeLobby) {
              btnResumeLobby.disabled = true;
              btnResumeLobby.classList.add('opacity-60');
          }
          if (btnToList) {
              btnToList.disabled = true;
              btnToList.classList.add('opacity-60');
          }

          // 화면에 먼저 표시
          setStatus('진행 중인 작전을 찾았다.', 'ok');
          fillContext();

      btnResumeGame.addEventListener('click', () => window.location.href = '/game.html');

          const loginResult = await window.cbCommon.login(session.userId, { silent: true });
          if (!loginResult.success) {
              autoHintEl.textContent = loginResult.message || '신원 확인 실패. 다시 인증하라.';
              setStatus('세션 복원 실패', 'warn');
              btnResumeGame.disabled = true;
              return;
          }

      // 로그인 성공 시 버튼만 활성화(자동 이동 없음)
      btnResumeGame.disabled = false;
  }

      init();
  })();
</script>
</body>
</html>
